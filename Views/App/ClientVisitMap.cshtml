@model IEnumerable<XenERP.Models.ClientMaster>

    @*<script src="~/Scripts/jquery-1.10.2.js"></script>
        <script src="~/Scripts/jquery.unobtrusive-ajax.js"></script>*@


    <script type="text/javascript" src="~/Scripts/JqueryValidation.js"></script>

    <script src="../../js/plugins/datetimepicker/bootstrap-datepicker.js" type="text/javascript"></script>
    <link href="~/css/datetimepicker/datepicker.css" rel="stylesheet" />

    <script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDY0kkJiTPVd2U7aTOAwhc9ySH6oHxOIYM&sensor=false&libraries=geometry"></script>

    <script type="text/javascript">
    var zoom ;
    $(document).ready(function () {
        var gmarkers = [];
        var gmarkersPrev = [];
        var linedraw = [];
        var map;
        var latprev;
        var longprev;
        var lastPosn;
        var points = [];
        var marker1;
        var route ;
        zoom = 12;
        var heading;
        var Id;
        var LstId;
        function initialize(la,lo) {

            var mapProp = {
                center: new google.maps.LatLng(la, lo), //India Lat and Lon
                zoom: zoom,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            map = new google.maps.Map(document.getElementById("googleMap"), mapProp);
            zoom = map.getZoom();

        }

            google.maps.event.addDomListener(window, 'load', initialize(22.5691413879395, 88.3521270751953));


        $("#dp3").datepicker({ autoclose: true, todayHighlight: true });

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; // Radius of the earth in km
            var dLat = deg2rad(lat2 - lat1);  // deg2rad below
            var dLon = deg2rad(lon2 - lon1);
            var a =
              Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
              Math.sin(dLon / 2) * Math.sin(dLon / 2)
            ;
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            var d = R * c; // Distance in km
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180)
        }


        function  Plotting(){
            var y = $("#txtDate").val();
            var x = $("#LinesManId").val();
            var z = $("#UnitId").val();

            // alert(y);
            // alert(x);
            // alert(z);

       //     for (i = 0; i < gmarkers.length; i++) {
      //          gmarkers[i].setMap(null);
     //       }


            $.ajax({
                type: "POST",
                url: '@Url.Action("ClientLocation", "App")', //"../Map/Search"
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({ "LinesManId": x, "BranchId": z, "Date": y, "DateString": y, "LinesManLatitude": null, "LinesManLongitude": null }),
                dataType: "json",
                success: function (data) {


                    var table = "<table class='table'>";
                    $.each(data, function (index, value) {
                        Id = value.Id;
                        if (Id >= LstId) {
                            if (index >= 1) {
                                var distance = getDistanceFromLatLonInKm(value.Latitude, value.Longitude, latprev, longprev)

                                table += "<tr><td>" + value.Date + "</td></tr>";

                                var latlng = new google.maps.LatLng(value.Latitude, value.Longitude);
                                lastPosn = marker1.getPosition();

                                heading = google.maps.geometry.spherical.computeHeading(lastPosn, latlng);




                                var marker = new google.maps.Marker({
                                    position: latlng,
                                    center: latlng,
                                    map: map,

                                    icon: {
                                        path: google.maps.SymbolPath.CIRCLE,
                                        scale: 3,
                                        fillColor: "red",
                                        fillOpacity: 0.8,
                                        strokeWeight: 2,
                                      //  rotation: heading //this is how to rotate the pointer
                                    }

                                });

                              //Date and Time Info Calculation

                                var dateString = value.Date.substr(6, 13);
                                var currentDate = new Date(parseInt(dateString));
                                var month = currentDate.getMonth() + 1;
                                var day = currentDate.getDate();
                                var year = currentDate.getFullYear();
                                var date = day + "/" + month + "/" + year;

                                var hours = currentDate.getHours();
                                var min = currentDate.getMinutes();
                                var sec = currentDate.getSeconds();

                                var time = hours + ":" + min + ":" + sec;

                                var add = "Date:" + date + " Time:" + time;

                                var infowindow = new google.maps.InfoWindow({
                                    content: add
                                });

                                marker.addListener('click', function () {
                                    infowindow.open(map, marker);
                                });
                              //----------------
                                gmarkers.push(marker);

                                linedraw.push({ lat: value.Latitude, lng: value.Longitude });

                                route = new google.maps.Polyline({
                                    path: linedraw,
                                    geodesic: true,
                                    strokeColor: '#FF0000',
                                    strokeOpacity: 1.0,
                                    strokeWeight: 2
                                });

                                route.setMap(map);

                                //    linedraw.splice(0, linedraw.length - 2);

                                marker1 = new google.maps.Marker({ position: latlng, map: map, visible: false });

                            }
                            else {
                                var latlng = new google.maps.LatLng(value.Latitude, value.Longitude);

                                var marker = new google.maps.Marker({
                                    position: latlng,
                                    map: map,
                                    icon: {
                                        path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                                        scale: 5,
                                        fillColor: "red",
                                        fillOpacity: 0.8,
                                        strokeWeight: 2
                                    }
                                });


                                var dateString = value.Date.substr(6, 13);
                                var currentDate = new Date(parseInt(dateString));
                                var month = currentDate.getMonth() + 1;
                                var day = currentDate.getDate();
                                var year = currentDate.getFullYear();
                                var date = day + "/" + month + "/" + year;

                                var hours = currentDate.getHours();
                                var min = currentDate.getMinutes();
                                var sec = currentDate.getSeconds();

                                var time = hours + ":" + min + ":" + sec;

                                var add = "Date:" + date + " Time:" + time;

                                var infowindow = new google.maps.InfoWindow({
                                    content: add
                                });

                                marker.addListener('click', function () {
                                    infowindow.open(map, marker);
                                });

                                marker1 = new google.maps.Marker({ position: latlng, map: map, visible: false });
                                gmarkers.push(marker);
                                linedraw.push({ lat: value.Latitude, lng: value.Longitude });
                            }

                        }

                        else {

                          //  return false;
                        }
                        latprev = value.Latitude;
                        longprev = value.Longitude;
                        LstId = value.Id;

                      //  alert(Id);
                      //  alert(LstId);
                    });

                    for (i = 1; i < gmarkers.length; i++) {
                        gmarkers[i].setIcon({
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 3,
                            fillColor: "red",
                            fillOpacity: 0.8,
                            strokeWeight: 2
                        });
                    }



                    var lastmarker = gmarkers.pop();

                 //    alert(lastmarker);
                    //      var lastmarker = gmarkers[gmarkers.length-1];
                    lastmarker.setIcon({
                        path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                        scale: 3,
                        fillColor: "red",
                        fillOpacity: 0.8,
                        strokeWeight: 2,
                        rotation: heading //this is how to rotate the pointer
                    });

                    gmarkers.push(lastmarker);
                    table += "</table>";


                }
            });
        }

        $("#UnitId").change(function () {
            var v = $("#UnitId").val();

            $.get("/App/GetLinesManName", { branchId: v }, function (data) {

                $("#LinesManId").empty();
                var options = $("#LinesManId");
                options.append(new Option("---Select LinesMan Name-----", "-1"));
                $.each(data, function () {
                    options.append(new Option(this.LinesmanName, this.Id));
                });


            });

        });


        $("#btnSearch").click(function () {

            var y = $("#txtDate").val();
            var x = $("#LinesManId").val();
            var z = $("#UnitId").val();
            linedraw = [];
            Id = 1;
            LstId = 1;
            polyline = new google.maps.Polyline({
                path: linedraw,
                strokeColor: "#FF0000",
                strokeOpacity: 1.0,
                strokeWeight: 2
            });


            for (i = 0; i < gmarkers.length; i++) {
               gmarkers[i].setMap(null);
            }

        //    for (i = 0; i < gmarkersPrev.length; i++) {
        //        gmarkersPrev[i].setMap(null);
        //    }

            $.ajax({
                type: "POST",
                url: '@Url.Action("Search", "App")', //"../Map/Search"
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({ "LinesManId": x, "BranchId": z, "Date": y, "DateString": y, "LinesManLatitude": null, "LinesManLongitude": null }),
                dataType: "json",
                success: function (data) {
                    //  alert(data[0].Latitude + ' ' + data[0].Longitude);
                    initialize(data[0].Latitude, data[0].Longitude);

                }
            });

            setInterval(function () {

                Plotting();
                // method to be executed;
            }, 10000);


        });
    });
    </script>
    <aside class="right-side">
        <div class="col-md-12">

            <div class="col-md-6">
                <div class="box box-primary">
                    <div class="box-header">  </div>
                    <div class="box-body">
                        <div class="form-group">
                            <label class="black_txt_010"> Unit Code :<span style="color:Red;">*</span> </label>
                            @Html.DropDownList("UnitId", new SelectList(ViewBag.FarmUnit, "Id", "Name"), "------None-----", new { @class = "form-control", @placeholder = "Enter Farm Unit Name", @maxlength = "100" })

                        </div>

                        <div class="form-group">
                            <label class="black_txt_010"> Marketing ExecutivesName:<span style="color:Red;">*</span> </label>
                            @Html.DropDownList("LinesManId", Enumerable.Empty<SelectListItem>(), "------None-----", new { @class = "form-control", @placeholder = "Enter Chicken Weight", @maxlength = "100" })

                        </div>

                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="box box-primary">
                    <div class="box-header">  </div>
                    <div class="box-body">


                        <div class="form-group">
                            <label class="black_txt_010"> Date:<span style="color:Red;">*</span> </label>
                            <div class="input-group date" id="dp3" data-date-format="@Session["DateFormatLower"]">@Html.TextBox("txtDate", DateTime.Now.ToString("dd/MM/yyyy"), new { @class = "form-control", @readonly = "" })  <span class="input-group-addon" style=" width:auto !important"><i class="glyphicon glyphicon-calendar"></i></span> </div>

                        </div>


                        <input name="" type="submit" id="btnSearch" value="Search" class="btn btn-primary">
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-12">
            <div id="googleMap" style="width:1000px;height:600px;"></div>

        </div>

        @*<table>
                <tr>
                    <td valign="top">
                        @Html.TextBox("txtSearch", null, new { @placeholder = "Search A Country" })
                        <div id="myData">
                            <table class="table">
                                @foreach (var item in Model)
                                {
                                    <tr>
                                        <td>
                                            @item.LocationName
                                        </td>
                                    </tr>
                                }

                            </table>
                        </div>
                    </td>
                    <td valign="top">
                    </td>
                </tr>
            </table>*@

    </aside>
